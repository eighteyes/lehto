<!doctype html>
<html lang="en" ng-app="app">
<head>
  <meta charset="UTF-8">
  <title>lehto</title>
  <script src="bower_components/angular/angular.js"></script>
  <script src="bower_components/jquery/dist/jquery.js"></script>
  <script src="bower_components/lodash/dist/lodash.js"></script>
  <script src="js/leaflet/leaflet.js"></script>
  <link rel="stylesheet" href="js/leaflet/leaflet.css"/>
  <style>
  body { font-family: sans-serif; background-color: #222; color: #EEF;}
  .col { width: 29%; margin: 0 2%; background-color:#334; float:left; }
  .col div { padding: 5px 10px; transition: 250ms; overflow: hidden;}
  .col div:hover {  background-color: rgba(100,100,100,0.5);}
  #map { height: 180px;}
  .highlight { background-color: #966;}
  .title { text-align:center; font-size:1.2em; background-color: #669;}
  </style>
  <script>
    var app = angular.module("app", []);

    app.service('CountryService', function($q, $http){
      return {
        getCountries: function() {
          var d = $q.defer();
          $http.get('countries.json').then(function(data) {
            d.resolve(data);
          });
          return d.promise;
        }
      }
    });

    app.service('ArtistService', function($q, $http){
      return {
        getArtists: function(cc) {
          var d = $q.defer();
          $http.get('country/'+cc).then(function(data) {
            d.resolve(data);
          });
          return d.promise;
        },
        getSimiliar: function(artist){
          var d = $q.defer();
          $http.get('similiar/'+artist).then(function(data) {
            d.resolve(data);
          });
          return d.promise;
        },
        getShows: function(artist){
          var d = $q.defer();
          $http.get('shows/'+artist).then(function(data) {
            d.resolve(data);
          });
          return d.promise;
        }
      }
    })

    app.controller('LehtoControl', function( $scope, CountryService, ArtistService ){
      CountryService.getCountries().then( function(data) {
        $scope.countries = _.sortBy(data.data, ['population'] ).reverse();
      });

      $scope.findArtists = function(cc){
        ArtistService.getArtists(cc).then( function(data) {
        $scope.artists = data.data;
        $scope.similiar = [];
      });

      $scope.findEvents = function(artist){

        ArtistService.getShows(artist).then( function(data){
          $scope.shows = data.data;
        })
      }

      $scope.getSimiliar = function(artist){
        $scope.artists = [artist];
        ArtistService.getSimiliar(artist).then (function (data){
          $scope.similiar = data.data;
        })
      }
      }
    });
  </script>
</head>
<body ng-controller="LehtoControl">
  <div class="col">
    <div ng-repeat="c in countries" ng-click="findArtists(c.cca2); highlight = true;" ng-class="{highlight: highlight}">{{ c.name }}</div>
  </div>
  <div class="col">
    <div ng-repeat="a in artists" ng-click="findEvents(a);getSimiliar(a);highlight = true" ng-class="{highlight: highlight}">{{ a }}</div>
    <div ng-show="similiar">
      <div class="title">Similiar Artists</div>
      <div ng-repeat="a in similiar" ng-click="findEvents(a);highlight = true" ng-class="{highlight: highlight}">{{ a }}</div>
    </div>
  </div>
  <div class="col">
    <div ng-repeat="s in shows">{{s.city}}, {{s.country}} <span style="float:right;font-size:0.8em;color:#666">{{s.date}}</span></div>
  </div>
</body>
</html>
